(window.webpackJsonp=window.webpackJsonp||[]).push([[388],{795:function(t,e,a){"use strict";a.r(e);var o=a(46),s=Object(o.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"abstract"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#abstract"}},[t._v("#")]),t._v(" Abstract")]),t._v(" "),a("p",[t._v("Currently, "),a("code",[t._v("SWAP")]),t._v(" and "),a("code",[t._v("DUP")]),t._v(" instructions are limited to a stack depth of 16. Introduce two new instructions, "),a("code",[t._v("SWAPn")]),t._v(" and "),a("code",[t._v("DUPn")]),t._v(", which lift this limitation and allow accessing the stack up to its full depth of 1024 items.")]),t._v(" "),a("h2",{attrs:{id:"motivation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#motivation"}},[t._v("#")]),t._v(" Motivation")]),t._v(" "),a("p",[t._v("Implementing higher level constructs, such as functions, on top of EVM will result in a list of input and output parameters as well as an instruction offset to return to.")]),t._v(" "),a("p",[t._v("The number of these arguments (or stack items) can easily exceed 16 and thus will require extra care from a compiler to lay them out in a way that all of them are still accessible.")]),t._v(" "),a("p",[t._v("Introducing "),a("code",[t._v("SWAPn")]),t._v(" and "),a("code",[t._v("DUPn")]),t._v(" will provide an option to compilers to simplify accessing deep stack items at the price of possibly increased gas costs.")]),t._v(" "),a("h2",{attrs:{id:"specification"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#specification"}},[t._v("#")]),t._v(" Specification")]),t._v(" "),a("h3",{attrs:{id:"option-a"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#option-a"}},[t._v("#")]),t._v(" Option A")]),t._v(" "),a("p",[t._v("Instructions "),a("code",[t._v("DUPn")]),t._v(" ("),a("code",[t._v("0xb0")]),t._v(") and "),a("code",[t._v("SWAPn")]),t._v(" ("),a("code",[t._v("0xb1")]),t._v(") are introduced, which take the top item from stack (referred to as "),a("code",[t._v("n")]),t._v(").")]),t._v(" "),a("p",[t._v("If "),a("code",[t._v("n")]),t._v(" exceeds 1024 or the current stack depth is less than "),a("code",[t._v("n")]),t._v(", then a stack underflow exception is issued. If the current stack depth is at the limit, a stack overflow exception is issued.\nIn both of these cases the EVM stops and all gas is consumed.")]),t._v(" "),a("p",[t._v("Otherwise")]),t._v(" "),a("ul",[a("li",[t._v("for "),a("code",[t._v("DUPn")]),t._v(" the stack item at depth "),a("code",[t._v("n")]),t._v(" is duplicated at the top of the stack")]),t._v(" "),a("li",[t._v("for "),a("code",[t._v("SWAPn")]),t._v(" the top stack item is swapped with the item at depth "),a("code",[t._v("n")])])]),t._v(" "),a("p",[t._v("The gas cost for both instructions is set at 3. In reality the cost for such an operation is 6 including the required "),a("code",[t._v("PUSH")]),t._v(".")]),t._v(" "),a("p",[t._v("Since both of these instructions require the top stack item to contain the position, it is still only possible to reach more than 16 stack items if there is at least one free stack slot.")]),t._v(" "),a("p",[t._v("This option has no effect no static analyzers, given no immediate value is introduced.")]),t._v(" "),a("h3",{attrs:{id:"option-a-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#option-a-2"}},[t._v("#")]),t._v(" Option A+")]),t._v(" "),a("p",[t._v("The difference to Option A is that "),a("code",[t._v("DUPn")]),t._v(" and "),a("code",[t._v("SWAPn")]),t._v(" must be preceded by a "),a("code",[t._v("PUSHn")]),t._v(" opcode. Encountering "),a("code",[t._v("DUPn")]),t._v(" and "),a("code",[t._v("SWAPn")]),t._v(" without a preceding "),a("code",[t._v("PUSHn")]),t._v(" results in out of gas.")]),t._v(" "),a("h3",{attrs:{id:"option-b"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#option-b"}},[t._v("#")]),t._v(" Option B")]),t._v(" "),a("p",[t._v("The difference to Option A is that "),a("code",[t._v("DUPn")]),t._v(" and "),a("code",[t._v("SWAPn")]),t._v(" do not take the value of "),a("code",[t._v("n")]),t._v(" from the top stack item, but instead encode it as a 16-bit big endian immediate value following the opcode.")]),t._v(" "),a("p",[t._v("This results in wasting a byte in the cases of only referring to the top 255 stack items.")]),t._v(" "),a("h3",{attrs:{id:"option-c"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#option-c"}},[t._v("#")]),t._v(" Option C")]),t._v(" "),a("p",[t._v("This option extends Option B with two new instructions, "),a("code",[t._v("DUPSn")]),t._v(" ("),a("code",[t._v("0xb2")]),t._v(") and "),a("code",[t._v("SWAPSn")]),t._v(" ("),a("code",[t._v("0xb3")]),t._v("), where the value of "),a("code",[t._v("n")]),t._v(" is encoded as an 8-bit immediate value following the opcode.")]),t._v(" "),a("p",[t._v("The value "),a("code",[t._v("n")]),t._v(" has a range of 0 to 255, but otherwise the same rules apply as in Option A.")]),t._v(" "),a("h2",{attrs:{id:"rationale"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rationale"}},[t._v("#")]),t._v(" Rationale")]),t._v(" "),a("p",[t._v("TBA")]),t._v(" "),a("h2",{attrs:{id:"backwards-compatibility"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backwards-compatibility"}},[t._v("#")]),t._v(" Backwards Compatibility")]),t._v(" "),a("p",[t._v("This has no effect on backwards compatibility.")]),t._v(" "),a("h2",{attrs:{id:"test-cases"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#test-cases"}},[t._v("#")]),t._v(" Test Cases")]),t._v(" "),a("ul",[a("li",[t._v("executing "),a("code",[t._v("602a600160026003600460056006600760086009600a600b600c600d600e600f60106011b0")]),t._v(" should have "),a("code",[t._v("42")]),t._v(" as the top stack item")]),t._v(" "),a("li",[t._v("executing "),a("code",[t._v("602a600160026003600460056006600760086009600a600b600c600d600e600f60106011b1")]),t._v(" should have "),a("code",[t._v("42")]),t._v(" as the top stack item")])]),t._v(" "),a("h2",{attrs:{id:"implementation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#implementation"}},[t._v("#")]),t._v(" Implementation")]),t._v(" "),a("p",[t._v("TBA")]),t._v(" "),a("h2",{attrs:{id:"references"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[t._v("#")]),t._v(" References")]),t._v(" "),a("p",[t._v("A similar proposal was made with "),a("a",{attrs:{href:"https://github.com/ethereum/EIPs/issues/174",target:"_blank",rel:"noopener noreferrer"}},[t._v("EIP-174"),a("OutboundLink")],1),t._v(". Read the thread for some detailed discussion.")]),t._v(" "),a("p",[t._v("Rootstock "),a("a",{attrs:{href:"https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP26.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("RSKIP26"),a("OutboundLink")],1),t._v(" also introduced "),a("code",[t._v("SWAPN")]),t._v(" and "),a("code",[t._v("DUPN")]),t._v(" with Option A described above.")]),t._v(" "),a("h2",{attrs:{id:"copyright"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#copyright"}},[t._v("#")]),t._v(" Copyright")]),t._v(" "),a("p",[t._v("Copyright and related rights waived via "),a("a",{attrs:{href:"https://creativecommons.org/publicdomain/zero/1.0/",target:"_blank",rel:"noopener noreferrer"}},[t._v("CC0"),a("OutboundLink")],1),t._v(".")])])}),[],!1,null,null,null);e.default=s.exports}}]);